@using Discord.WebSocket
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager Navigation
@inject DiscordSocketClient DiscordClient

<AuthorizeView>
    <Authorized>
        <div class="min-h-screen flex flex-col relative">
            
            <!-- Top Navigation Header (Sticky) -->
            <header class="sticky top-0 z-50 glass border-b border-glass-border">
                <div class="max-w-7xl mx-auto">
                    <!-- Top Row: Context & Profile -->
                    <div class="flex items-center justify-between px-4 h-16">
                        <div class="flex items-center gap-4">
                            <a href="/servers" class="p-2 -ml-2 rounded-xl text-gray-500 hover:text-primary hover:bg-primary/5 transition-colors">
                                <span class="material-icons-round text-xl">arrow_back</span>
                            </a>
                            
                            @if (Guild != null)
                            {
                                <div class="flex items-center gap-3">
                                    @if (!string.IsNullOrEmpty(Guild.IconUrl))
                                    {
                                        <img src="@Guild.IconUrl" class="w-8 h-8 rounded-lg shadow-sm" alt="@Guild.Name" />
                                    }
                                    else
                                    {
                                        <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary font-bold text-xs">
                                            @Guild.Name[0]
                                        </div>
                                    }
                                    <h1 class="font-bold text-sm sm:text-base truncate max-w-[150px] sm:max-w-xs">@Guild.Name</h1>
                                </div>
                            }
                        </div>

                        <div class="flex items-center gap-3">
                            <span class="text-sm font-bold text-gray-600 dark:text-gray-300 hidden sm:block">@context.User.Identity?.Name</span>
                            <img src="@context.User.FindFirst("urn:discord:avatar")?.Value" class="w-8 h-8 rounded-full border border-glass-border" />
                        </div>
                    </div>

                    <!-- Bottom Row: Navigation Tabs (Horizontal Scroll) -->
                    <div class="flex items-center px-4 gap-1 overflow-x-auto hide-scroll pb-0">
                        <a href="/server/@GuildId" class="@NavLinkClass("") px-4 py-2.5 text-sm font-bold rounded-t-lg border-b-2 transition-all whitespace-nowrap">
                            Overview
                        </a>
                        <a href="/server/@GuildId/features" class="@NavLinkClass("features") px-4 py-2.5 text-sm font-bold rounded-t-lg border-b-2 transition-all whitespace-nowrap">
                            Features
                        </a>
                        <a href="/server/@GuildId/moderation" class="@NavLinkClass("moderation") px-4 py-2.5 text-sm font-bold rounded-t-lg border-b-2 transition-all whitespace-nowrap">
                            Moderation
                        </a>
                        <a href="/server/@GuildId/analytics" class="@NavLinkClass("analytics") px-4 py-2.5 text-sm font-bold rounded-t-lg border-b-2 transition-all whitespace-nowrap">
                            Analytics
                        </a>
                        <a href="/server/@GuildId/automation" class="@NavLinkClass("automation") px-4 py-2.5 text-sm font-bold rounded-t-lg border-b-2 transition-all whitespace-nowrap">
                            Automation
                        </a>
                        <a href="/server/@GuildId/settings" class="@NavLinkClass("settings") px-4 py-2.5 text-sm font-bold rounded-t-lg border-b-2 transition-all whitespace-nowrap">
                            Settings
                        </a>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="flex-1 max-w-7xl mx-auto w-full p-4 sm:p-6 lg:p-8">
                @ChildContent
            </main>
        </div>
    </Authorized>
</AuthorizeView>

@code {
    [Parameter] public string GuildId { get; set; } = "";
    [Parameter] public string ActivePage { get; set; } = "";
    [Parameter] public RenderFragment ChildContent { get; set; } = default!;

    private SocketGuild? Guild => ulong.TryParse(GuildId, out var id) ? DiscordClient.GetGuild(id) : null;

    private string NavLinkClass(string pageName)
    {
        bool isActive = ActivePage.Equals(pageName, StringComparison.OrdinalIgnoreCase);
        return isActive
            ? "border-primary text-primary bg-primary/5"
            : "border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 hover:bg-gray-100/50 dark:hover:bg-white/5";
    }
}